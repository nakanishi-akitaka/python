# -*- coding: utf-8 -*-
"""
Created on Wed Feb 27 21:25:39 2019

@author: Akitaka
"""

[1] 機械学習
[1a] サイトで勉強　金子研究室
データ解析に関するいろいろな手法・考え方のまとめ
https://datachemeng.com/summarydataanalysis/
学生・研究者へ
https://datachemeng.com/forstudentsresearchers/

[1a2]
https://twitter.com/hirokaneko226/status/1100502972428111872
    hERG阻害活性を予測するディープニューラルネットワークの論文。
    ChEMBLなどで収集した7889化合物を利用。
    IC50の閾値を10, 20, 40, 60, 80, 100 μM と振ってマルチタスクでネットワークを学習。
    記述子はMol2vec とMOE。SVMやRFなどと比較。バーチャルスクリーニングに応用

https://doi.org/10.1021/acs.jcim.8b00769
"Deep Learning-Based Prediction of Drug-Induced Cardiotoxicity"
Chuipu Cai, et al.,
J. Chem. Inf. Model.  XXXX, XXX, XXX-XXX


[1b] 遺伝的アルゴリズム & ランダム構造探索 テスト計算
[1b1] 基本設定と履歴
1.ランダム構造探索 = 0世代、100個体の遺伝的アルゴリズム
2.遺伝的アルゴリズム、4世代、10個体、選別率 0.2、変異率 0.5
0222 Al
0225 2Si, 2C, 2Be
0226 4C run1,run2(実行中)
    v_ave = 200 => 300
    ecutwfc = 30 => 60
    ecutrho = 240 => 480
    
[1b2] 4C run2

理想
Etot, a, b, c, cos(α,β,γ), τ1(x,y,z), τ2(x,y,z), ... =
    new unit-cell volume =    282.51765 a.u.^3 (    41.86480 Ang^3 )
    Efinal=   -45.58299892
    4.65289,   1.00000,   3.23851,  -0.50000,   0.00000,   0.00000,   
    0.00000,   0.00000,   0.00000,   0.66667,   0.33333,   0.00000,   
    0.00000,   0.00000,   0.50000,   0.33333,   0.66667,   0.50000
=>
    Space Group 194  D6h-4     P6_3/mmc


1. RS
top1 = indv21
    total energy         =    -45.58348586 Ry
    new unit-cell volume =    292.47304 a.u.^3 (    43.34003 Ang^3 )
    4.65573,   1.78770,   1.99824,   0.03273,   0.50054,   0.31713,   
    0.00000,   0.00000,   0.00000,   1.33308,  -0.00003,   0.16693,   
    0.33298,   0.99965,   0.66690,   0.99992,   0.99973,   0.49998
=>
    Space Group  12  C2h-3     C2/m  


出てない？
Volumeで検索しても、283 a.u.^3 近くになるのが少ない
Etot も　Volume も近いのは以下の通り
indv15
    total energy         =    -45.58324144 Ry
    new unit-cell volume =    288.05915 a.u.^3 (    42.68596 Ang^3 )
    4.65532,   2.18390,   2.64702,   0.01863,  -0.62530,  -0.61567,   
    0.00000,   0.00000,   0.00000,   0.00087,   0.66703,   0.66692,   
    0.00005,   0.50007,   0.49997,   0.00082,   0.16695,   0.16695
=>
    Space Group   1  C1-1      P1

indv16
    total energy         =    -45.58276617 Ry
    new unit-cell volume =    289.89127 a.u.^3 (    42.95745 Ang^3 )
    4.65511,   1.70333,   1.99814,   0.08301,   0.50029,  -0.13628,   
    0.00000,   0.00000,   0.00000,   0.99988,   0.99971,   0.50004,   
    0.66691,   0.99999,   0.83304,   0.66677,   0.99968,   0.33310
=>
    Space Group   2  Ci-1      P-1   

=>
これらの最適化結果をもう一度、構造最適化してみる
indv15
    total energy         =    -45.58238013 Ry
    new unit-cell volume =    352.94367 a.u.^3 (    52.30086 Ang^3 )
    4.65606,   2.18465,   2.53526,   0.09838,  -0.47931,  -0.65068,   
    0.00000,   0.00000,   0.00000,  -0.33302,   0.66694,   0.66693,   
    0.00000,   0.50001,   0.49999,  -0.33302,   0.16694,   0.16693
    変化はしたが、どのみちグラファイトではない


indv16
    total energy         =    -45.58333447 Ry
    new unit-cell volume =    290.03248 a.u.^3 (    42.97838 Ang^3 )
    4.65586,   1.70369,   1.99803,   0.08311,   0.50045,  -0.13636,   
    0.00000,   0.00000,   0.00000,   1.00001,   0.99980,   0.49996,   
    0.66694,   1.00000,   0.83306,   0.66695,   0.99979,   0.33301
    ほぼ変化なし


2. GA
top1 = generation0/indv10
    total energy         =    -45.58329266 Ry
    new unit-cell volume =    301.59336 a.u.^3 (    44.69152 Ang^3 )
    4.65306,   3.48514,   0.99999,  -0.02750,   0.50000,   0.09382,   
    0.00000,   0.00000,   0.00000,   0.33332,   1.00003,   0.33335,   
    0.37594,   0.47158,  -0.02922,   1.04260,   0.47160,   0.63743
=>
    Space Group   1  C1-1      P1 

出てない？
Etot, Volumeで検索。一番近いのはこれ
generation2/indv1
    total energy         =    -45.58308256 Ry
    new unit-cell volume =    282.74140 a.u.^3 (    41.89795 Ang^3 )
   16.85921,   0.27599,   0.27599,   0.50001,   0.00412,   0.38927,   
    0.00000,   0.00000,   0.00000,  -0.00004,   0.66676,   0.66662,   
    0.48327,   0.13813,   0.49955,   0.48330,   0.47138,   0.83292
=>
    Space Group   2  Ci-1      P-1 

何が原因かは分からないが、グラファイトは出なかった
エネルギーの精度がもっと必要なのかもしれないし、擬ポテンシャルの問題かもしれない
テスト計算でこれ以上拘っても仕方ないのでこれで打ち切り


[1b3] 4Si
Si4個も試そうかと思ったが、最安定構造であるダイヤモンド構造を、
原子4個で表す方法が分からないので飛ばす


[1b4] 2Mg
http://www.crystalbase.co.jp/index/d/mg.html
    結晶構造	六方晶 （最密充填構造）
    格子定数	a = 3.2094Å   c = 5.2103Å
              a = 6.0648888 [a.u.] c/a = 1.62344987
=>
テスト計算のvcrelaxが長いので、パス


[1b5] Ca
http://iwate.riast.osakafu-u.ac.jp/~kiso1/periodictable.html
    FCC a = 5.58 AA = 11.111593 [a.u.]
計算中




[1c] 特徴量の重要度ランキング
20180920 先行研究１
    "Machine learning modeling of superconducting critical temperature"
    https://arxiv.org/abs/1709.02727
    20170911 論文読み　概略
    20180628 論文読み　モデルの評価方法
    20180920 論文読み　正式出版後、全体

    この論文の先行研究での特徴量について
    例：単純なクラスタリング
        Tc>10Kの超伝導60個での重要な説明変数は３つ：
        価電子数の平均、軌道半径の差分、電気陰性度の差分
        Tc<10Kの超伝導600個は↑のだとバラバラに分布

    ランダムフォレスト回帰
    1.特徴量=組成のみ => Tc 10K以上と未満と2通りに分けるモデル
    2.特徴量=組成＋AFLOWから取得 => Tcを具体的に予測するモデル

    この論文の特徴量について 20180920のメモより
    p.2
    データベースにあるのは、ほとんどが化学式とTcのみ
    特徴量を作るため、以下を使用する
    Materials Agnostic Platform for Informatics and Exploration (Magpie)
    クラスタリング先行研究の発展になる

    p.3
    Magpieによる特徴量を使うとうまくいく一方で、解釈が難しくなる
    それによる特徴量には直接的には重要な特性を含まないからである
    AFLOW Onlineで、そのようなデータを取得する
    170,000,000近いデータ by AFLOW計算パッケージ
    
    SuperConにもICSDにもあるデータは少ない 800ぐらい
    さらにAFLOWにもあるのは600未満
    26個の特徴量
        格子のタイプ、空間群～Bader電荷など※詳しくはMethods
    先行研究によると、似たようなデータセットを孤立に(？)機械学習に応用するのは限界がある
    ここでは、2つの特徴量を用いる(？)
    Magpie: サンプリング多い、組成のみからなる特徴量
    AFLOW: サンプリング少ない、大量で適切な特徴量

    p.4
    トレーニングデータの数や、特徴量の数に対するスコアを計算
    後者は10を切った辺りから急にスコアが悪くなる
    特徴量は145あったのを重要な5つに減らしても、90%の正解率が出せる。
    
    特徴量のジニ重要度を調べた。
    特徴量の間に相関があるとまずいので、減少式で変数選択を行った。
    5つ(2%)だけを残しても精度は問題ない
    その内2つはお互いに強く相関するので1つを削除
    4つが重要な特徴量だとわかった(Table 1)
    重要な特徴量に対する散布図はFig3a,b
    　　列が大きい＆電気陰性度が高い、質量の軽い方だとTc>10Kの傾向
    
    先行研究で使われた特徴量を用いたモデルも作成した
    精度は今回のよりも正解率とF1が3%悪い
    4つだけの特徴量モデルと比べるなら、むしろ先行研究の方が2%優秀
    ※使われた特徴量
        先行研究:価電子数の平均、軌道半径の差分、電気陰性度の差分
        本研究:周期表の列の標準偏差、電気陰性度の標準偏差、
                融点の標準偏差、原子の質量の平均
    # 電気陰性度は同様、価電子数は列と強い相関がある
    # あとは軌道半径と融点&質量も関係ある？

    p.5
    Table 1:重要な説明変数とその重要度のランキング
    分類
    1.周期表の列の標準偏差
    2.電気陰性度の標準偏差
    3.融点の標準偏差
    4.原子の質量の平均

    回帰(low-Tc,Cu,Fe全部を予測するモデル)
    1.非占有軌道の数の平均
    2.標準状態の体積の標準偏差
    3.空間群の標準偏差
    4.dが非占有の軌道の数の平均
    5.d価電子の数の標準偏差
    6.融点の平均
    
    p.6
    Fig.3:クラス分類における4つの重要な特徴量に対する散布図 (a) best1&2 (b) best3&4
    　青：Tc<10K、赤：Tc>10K

    p.7
    Table 2:low-Tc,Cu,Fe、それぞれのモデルでの、重要な説明変数とその重要度のランキング
    d軌道の電子数、空間群など、圧力で変わりそうな値がそこそこある
    
    ここでも変数選択は行った
    基準が正解率→R^2になる
    重要な特徴量はTable 1&2を参照
    low-Tcの特徴量の重要度がばらけているのは、複数のグループ(電子フォノン以外)があるため
    Fig.5より、low-Tcでは質量**(-0.5)が重要な特徴量だと分かる。
    また、low-Tcでは価電子数も重要。これはマチスの法則(60年前)とも一致する
    機械学習で重要な規則性を発見できることの証左
    他、共有結合半径も大事
    
    他のグループの特徴量について
    
    p.8
    Fig.5:Tcと重要な特徴量の散布図
    (a) low-Tc vs 質量の平均
    (b) low-Tc vs 共有結合半径の平均
    (c) low-Tc vs d価電子の数の平均
    (d) Cu Tc vs 非占有軌道の数の平均
    (c),(d)は小さいほどTcが高い→Tcの上限がある
    
    Including AFLOW
    Magpieの特徴量:eV単位
    超伝導:meV単位
    にも拘わらず、正確なモデルを作成できた
    モデルの解釈という点ではあまり好ましくない
        原子レベルの特徴量よりも、
        観測可能なマクロな物性ベースの特徴量によるモデルの方が非常に望ましい

    SuperConのごく一部のみが、ICSDにも入っている
        1500化合物、Tcがあるのは800
        ICSDに載ってる超伝導は、non-stoichiometric/dopedなものが多い　→　DFTには不便
        その他は、AFLOWで計算をしようとしたものの、納得できる結果に収束しなかった
    実際、既知の超伝導体はdisordered (offstoichiometric)が多い
    
    適切な特徴量を抽出するために、AFLOW Onlineと連動させた
        AFLOWパッケージによる第一原理計算のデータ
    ICSDにある物質の大半はある
    超伝導体は550ぐらい
    これを利用した先行研究がある
        ただし、クラス分類は上手くいったが、回帰分析が残念な結果に
    我々はMagpieによる特徴量も使用することで回帰分析がうまくいった

    p11
    Chemical and structural features
    特徴量はMagpieを使って計算した
    各物質につき145個の特徴量
    (1)原子の割合のみに依存する量
    (2)原子の特性：族、周期、原子半径、融点などの平均、最大値、最小値など
    (3)電子的特性：s,p,d,fなど
    (4)イオン化合物の特性：よく分からない
    
    AFLOW Onlineにある超伝導のデータを使ったモデル「も」作成
    第一原理計算によるデータベース、パラメーターは統一してあるらしい　　→機械学習には好都合
    特徴量の作成に用いたもの
    原子の個数、空間群、密度、体積、エネルギー、エントロピー、価電子数、放射線の減衰波長？
    ユニットセルの次元の割合、Barder電荷、Barder体積
    

20190122　先行研究２
    "A Data-Driven Statistical Model for Predicting the Critical
    Temperature of a Superconductor"
    https://arxiv.org/abs/1803.10260
    20180629 論文読み
    20181017 先行研究XGBoost => GBoostで水素化物Tcでやってみる
    20190122 論文読み 復習
    
    Table 5:XGBで重要だった特徴量top20
    作成に用いた物性は8種類だが、ここにあるのは5種類
    thermal conductivity, atomic radius, valence, 
    electron affinity, atomic mass
    top 5
        0.295: range ThermalConductivity
        0.084: wtd std ThermalConductivity
        0.072: range atomic radius 
        0.047: wtd gmean ThermalConductivity 
        0.042: std ThermalConductivity 

20181129 自分
    ランダムフォレストで特徴量選択
    方法
        新しい説明変数でやってみる ref:20181122, https://arxiv.org/abs/1803.10260
        RandomForestRegressor.feature_importances_によって取得できる。
    結果
        大半が重要度0.05以下
        0.1269: No.17, 第一イオン化エネルギー + Weighted entropy = −Aln(A)−Bln(B)
        0.1256: No.35, 融点 + Weighted geometric mean = (t1)**p1*(t2)**p2
        0.0943: No.05, 質量 + Weighted geometric mean = (t1)**p1*(t2)**p2
        0.0540: No.19, 第一イオン化エネルギー + Weighted range = p1 t1 − p2 t2
        0.0479: No.27, 原子半径 + Weighted entropy = −A ln(A) − B ln(B)
        0.0424: No.01, 圧力
        0.0418: No.45, 価電子 + Weighted geometric mean = (t1)**p1*(t2)**p2
        意外にも、No.01 圧力の重要度は0.042止まり。top6/51なので高い方ではあるが。




まとめ
Phys. Rev. B 37, 2345–2348 (1988)
    Tc>10Kの超伝導60個でのクラスタリング
        価電子数の平均、軌道半径の差分、電気陰性度の差分

arxiv.1709.02727
    ランダムフォレストで特徴量選択
    Tc > Tsep or Not 分類
        周期表の列の標準偏差, 電気陰性度の標準偏差, 融点の標準偏差, 原子の質量の平均
    Tcの定量的な回帰分析
        非占有軌道の数の平均, 標準状態の体積の標準偏差, 空間群の標準偏差
        dが非占有の軌道の数の平均, d価電子の数の標準偏差, 融点の平均
    
arxiv.1803.10260
    XGBoostingで特徴量選択
    Tcの定量的な回帰分析
        熱伝導率の差分、熱伝導率の重み付き平均、原子半径の差分、
        熱伝導率の重み付き相乗平均、熱伝導率の標準偏差、
        他、価電子、電気陰性度、質量からなる特徴量

中西 20181129
    ランダムフォレストで特徴量選択
    水素化合物のTcの定量的な回帰分析
        第一イオン化エネルギーの重み付きエントロピー、融点の重み付き相乗平均
        質量の重み付き相乗平均、第一イオン化エネルギーの重み付き差分
        圧力、価電子の重み付き相乗平均




[todo]=>[done] 
ランダムフォレスト+水素化合物とXGBoost+常圧超伝導でなぜ特徴量の重要度が全然違うのか？を調べる

Q.ランダムフォレストだけでなく、GBoostでも特徴量の重要度調査はできる？
A.OK ドキュメントより
https://scikit-learn.org/stable/modules/generated/
    sklearn.ensemble.GradientBoostingRegressor.html

20181017 先行研究XGBoost => GBoostで水素化物Tcでやってみる
20181129 ランダムフォレストで重要度調べる
    ここの時点で、Tc_9model.pyに、GBoostも入っていた。
=>
20181214 で、微修正&リネーム(tc_pred.py)しているので、そちらをベースにする。
また、lwpls.py をmy_library.pyに統合

Random Forest   
Best parameters set found on development set:
{'max_features': 0.30000000000000004}
C:  RMSE, MAE, R^2 =  8.908,  6.197,  0.978
CV: RMSE, MAE, R^2 = 23.952, 15.569,  0.838
TST:RMSE, MAE, R^2 = 25.545, 12.954,  0.713
 0.042
 0.010,  0.014,  0.009,  0.121,  0.004,  0.009,  0.010,  0.015,  0.002,  0.023
 0.001,  0.005,  0.016,  0.028,  0.005,  0.073,  0.010,  0.041,  0.001,  0.009
 0.002,  0.033,  0.002,  0.023,  0.010,  0.047,  0.001,  0.003,  0.021,  0.002
 0.011,  0.016,  0.053,  0.068,  0.039,  0.028,  0.001,  0.014,  0.001,  0.013
 0.002,  0.011,  0.010,  0.086,  0.002,  0.012,  0.003,  0.004,  0.002,  0.033
14.65 seconds 

Gradient Boosting
Best parameters set found on development set:
{'max_features': 0.4}
C:  RMSE, MAE, R^2 = 11.953,  8.551,  0.960
CV: RMSE, MAE, R^2 = 22.649, 13.887,  0.856
TST:RMSE, MAE, R^2 = 17.928, 12.178,  0.862
 0.162
 0.019,  0.022,  0.009,  0.041,  0.018,  0.037,  0.012,  0.014,  0.018,  0.033
 0.008,  0.013,  0.014,  0.034,  0.006,  0.040,  0.006,  0.034,  0.001,  0.046
 0.005,  0.006,  0.009,  0.008,  0.011,  0.030,  0.014,  0.033,  0.001,  0.041
 0.005,  0.029,  0.005,  0.045,  0.004,  0.032,  0.007,  0.030,  0.002,  0.014
 0.002,  0.007,  0.010,  0.027,  0.001,  0.006,  0.002,  0.016,  0.002,  0.011
21.11 seconds 


特徴量の重要度 0.040 以上のみ表示でまとめ
ランダムフォレスト 今回
    0.121: No.04 質量 + Weighted geometric mean
    0.086: No.44 価電子 + Weighted geometric mean
    0.073: No.16 第一イオン化エネルギー + Weighted entropy
    0.068: No.34 融点 + Weighted geometric mean
    0.053: No.33 融点 + Geometric mean
    0.047: No.26 原子半径 + Weighted entropy
    0.042: No.00 圧力
    0.041: No.18 第一イオン化エネルギー + Weighted range

ランダムフォレスト 前回 20181129　※ナンバリングは1つずれる
    0.1269: No.17 第一イオン化エネルギー + Weighted entropy
    0.1256: No.35 融点 + Weighted geometric mean
    0.0943: No.05 質量 + Weighted geometric mean
    0.0540: No.19 第一イオン化エネルギー + Weighted range
    0.0479: No.27 原子半径 + Weighted entropy 
    0.0424: No.01 圧力
    0.0418: No.45 価電子 + Weighted geometric mean 

GBoost
    0.162: No.00 圧力
    0.041: No.04 質量 + Weighted geometric mean
    0.040: No.16 第一イオン化エネルギー + Weighted entropy
    0.046: No.20 第一イオン化エネルギー + Weighted standard deviation
    0.041: No.30 融点 + Weighted standard deviation
    0.045: No.34 融点 + Weighted geometric mean

よって、そもそもの疑問への答えはこうなる
Q.ランダムフォレスト+水素化合物とXGBoost+常圧超伝導でなぜ特徴量の重要度が全然違うのか
A.同じデータベースを元にしても、回帰分析手法が違えば、変わるもの
    =>単純に、「この特徴量が大事」とは言えないのでは？




